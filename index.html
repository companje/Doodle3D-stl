
<!DOCTYPE html> 
<html>
<head>
	<title>Details</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="libs/jquery.mobile-1.4.2.min.css" />	<!-- http://code.jquery.com/mobile/1.4.2/ -->
	<script src="libs/jquery-1.9.1.min.js"></script>
	<script src="libs/jquery.mobile-1.4.2.min.js"></script> <!-- http://code.jquery.com/mobile/1.4.2/ -->
	<link rel="stylesheet" href="css/styles.css" />
</head>

<body>
	
<div data-role="page" id="print">
	<a href="#devices"><img id="logo" src="img/logo_stl.gif"></a>

	<div data-role="header">
		<a href="../toolbar/" data-rel="back" class="ui-btn ui-btn-left ui-alt-icon ui-nodisc-icon ui-corner-all ui-btn-icon-notext ui-icon-carat-l">Back</a>
		<h1>3D-Print STL</h1>
	</div><!-- /header -->

	<div role="main" class="ui-content">
		<!-- <input type="file" name="file" placeholder="STL file" value="" disabled="yes" > -->

		<input type="text" id="stl_file" name="stl_file" placeholder="http://yoursite.com/yourstl.stl" value="http://companje.nl/cura/upload/20mm_Calibration_Box.stl">
		<a href="#printing" class="ui-shadow ui-btn ui-corner-all" id="btnPrint">3D-Print</a>
	</div><!-- /content -->
</div><!-- /page -->

<div data-role="page" id="printing">
	<a href="#devices"><img id="logo" src="img/logo_stl.gif"></a>

	<div data-role="header">
		<a href="../toolbar/" data-rel="back" class="ui-btn ui-btn-left ui-alt-icon ui-nodisc-icon ui-corner-all ui-btn-icon-notext ui-icon-carat-l">Back</a>
		<h1>Printing...</h1>
	</div><!-- /header -->

	<div role="main" class="ui-content">
		<a id="btnStop" href="#print" class="ui-shadow ui-btn ui-corner-all">Stop Print</a>
	</div><!-- /content -->
</div><!-- /page -->

<div data-role="page" id="update">
	<div data-role="header"></div><!-- /header -->
</div><!-- /page -->


<script>

	var gcode;
	var doodle3d_api = "http://10.0.0.244/d3dapi/";
	var cura_api = "http://companje.nl/cura/";
	var chunks = [];


	$("#btnStop").click(function() {
		console.log("stop print");
		$.ajax({
		  url: doodle3d_api + "printer/stop",
		  type: "POST"
		});
	});

	$("#btnPrint").click(function() {
		showLoader(true,"Converting STL to GCODE...");

		setInterval(updateProgress,1000);

		var gcode_file = cura_api + "?input=" + $("#stl_file").val();

		$.get(gcode_file, function(data) {
			gcode = data;

			var lines = gcode.split("\n");
			var chunkMaxLines = 500;
			chunks = []; //empty

			console.log("total lines: ",lines.length);
			console.log("dividing into: ",Math.ceil(lines.length/chunkMaxLines),"chunks");
			console.log("average chunk size: ",lines.slice(0,500).join("\n").length,"bytes")

			for (var i=0; i<lines.length / chunkMaxLines; i++) {
				var from = i*chunkMaxLines;
				var to = chunkMaxLines*(i+1)-1;
				to = Math.min(to,lines.length-1);
				var chunk = lines.slice(from,to).join("\n");
				chunks.push(chunk);
			}
		
			sendChunk(0);
		})
	});

	function sendChunk(current) {
		console.log("sending chunk",current+1,"of",chunks.length);
		
		var data = { gcode:chunks[current], first:current==0, start:current==0 };
		
		showLoader(true,"Uploading GCODE... "+(Math.ceil((current+1)/(chunks.length)*100))+"%");

    $.ajax({
		  url: doodle3d_api + "printer/print",
		  type: "POST",
		  data: data,
		  dataType: 'json',
		  timeout: 5000, //this.sendPrintPartTimeoutTime,
		  success: function(data) {
		  	console.log("send chunk",current,"success",data);
		  	
		  	if (current>=chunks.length-1) {
		  		console.log("done");
					showLoader(false);
		  	} else if (data.status=="success") {
		  		sendChunk(current+1);
		  	} else if (data.status=="error") {

		  	}
		  }
		}).fail(function(data) {
			console.log("send chunk failed",data);
		});		
	}

	function updateProgress() {
		$.get(doodle3d_api+"printer/progress", function(data) {
			var curent_line = data.data.current_line;
			var total_lines = data.data.total_lines;
			var progress;

			if (total_lines==0) {
				progress = 0;
			} else {
				progress = Math.round(curent_line/total_lines*100*100)/100; //round two decimals
			}

			$("#printing h1").text("Printing... " + progress + "%");

		});
	}

	function showLoader(b,text) {
		if (b==true) $.mobile.loading("show", {text:text, textVisible: text!=undefined} );
		else $.mobile.loading("hide");
	}

	function log(text) {
		$("#status").html(text + "<br>");
	}

	$(function(){
		$( "[data-role='header'], [data-role='footer']" ).toolbar();
	});

</script>

</body>
</html>